# Протоколы DHCP и DNS

1. Настройка интерфейсов
2. Настройка DHCP-сервера
3. Запуск DHCP-клиента. Анализ перехваченных пакетов
4. Анализ перехваченных пакетов. Часть2
5. Установка lease-time
6. Повторный запрос адреса
7. DNS.Проверка настроек интерфейсов
8. Настройка DNS-сервера
9. Запуск DNS-сервера
10. Настройка резолвера DNS
11. Анализ DNS-запроса
12. Анализ DNS-ответа
13. Анализ пакетов реверсивного DNS-запроса

---


#### 1. Настройка интерфейсов

> Для работы сети необходимо, чтобы каждый хост имел собственный сетевой адрес. Такой адрес может быть задан статически администратором. Сеть может включать большое число компонентов и узлов, которым требуются сетевые адреса. В этом случае назначение адресов ручным способом потребует больших затрат времени и может привести к ошибкам, например, когда два параллельно работающих человека задают одинаковые сетевые адреса различным хостам. Чтобы этого избежать, используются специальные сетевые службы, позволяющие назначать адреса динамически, без непосредственного участия человека.

> Dynamic Host Configuration Protocol (DHCP, англ. «протокол динамической конфигурации хостов», RFC 2131) – протокол, который используется для автоматического распределения IP-адресов хостам в сети. Кроме настройки адресов протокол позволяет передавать хостам различные параметры, такие как адреса серверов DNS и NTP, маршрут по умолчанию и др.

> Подключитесь к интерфейсу командной строки маршрутизатора, нажав пикторграмму Mikrotik на стенде. Настройте на интерфейсе ether2 ip-адрес 192.168.109.1 с маской /24

```
/ip address
print
add interface=ether2 address=192.168.109.1 netmask=255.255.255.0
print
```

#### 2. Настройка DHCP-сервера

> Платформа MikroTik RouterOS включает в себя функционал как сервера, так и клиента, работающих согласно RFC2131. Маршрутизатор позволяет настроить отдельный сервер для каждого Ethernet-подобного интерфейса. DHCP-сервер MikroTik RouterOS поддерживает базовые функции предоставления клиентам IP - адресов, а также информации о маске подсети, шлюзе по умолчанию, имени домена, DNS-серверах, WINS-серверах (для клиентов с Windows).

> Протокол DHCP имеет клиент-серверную архитектуру. При автоматической настройке DHCP-клиент запрашивает необходимые ему параметры у DHCP-сервера.

> Преимущество использования DHCP заключается в простоте перенастройки сети при её модификации или расширении, например, изменение адреса DNS сервера потребует изменений только на DHCP сервере, а все сетевые хосты будут перенастроены в момент следующего запроса их DHCP клиента к DHCP серверу. Ещё одно преимущество заключается в простом подключении новых компьютеров к сети, поскольку не требуется проверять доступность IP адресов. При использовании DHCP конфликты среди выделяемых IP адресов также будут минимальны.

> Настройте на интерфейсе ether2 маршрутизатора, к которому подключено рабочее место DHCP-сервер со следующими параметрами:

> 1. Пул адресов – пул,в который входят адреса с 10-го по 200-ый из подсети вашего варианта.

> 2. Шлюз по умолчанию – адрес маршрутизатора.

> 3. DNS сервер – 8.8.8.8.

> RouterOS имеет встроенные команды для быстрой упрощенной настройки DHCP-сервера.

> Для настройки DHCP-сервера на интерфейсе ether2 с целью распределения адресов начиная с 192.168.109.10 по 192.168.109.200 из сети 192.168.109.0/24, необходимо из меню `/ip dhcp-server` запустить команду setup и далее заполнить нужные параметры:
`ip dhcp-server setup`

> Вы можете проверить правильность настройки DHCP-сервера, используя команду print в подменю `ip dhcp-server`:

```
/ip dhcp-server
print
setup

dhcp server interface: ether2
dhcp address space: 192.168.109.0/24
gateway for dhcp network: 192.168.109.1
addresses to give out: 192.168.109.10-192.168.109.200
dns servers: 8.8.8.8
lease time: 10m

print
```


#### 3. Запуск DHCP-клиента. Анализ перехваченных пакетов

> Сообщение протокола DHCP состоит из следующих полей:

> • Op – тип сообщения (1 – BOOTREQUST, 2 – BOOTREPLY).

> • Htype – тип оборудования канального уровня, значения аналогичны тем, что используются в протоколе ARP, например, «1» соответствует типу 10 Мб Ethernet.

> • Hlen – длина адреса оборудования в байтах, например, 6 – соответствует технологии Ethernet.

> • Hops – для клиента заполняется нулям, опционально может быть использовано агентом посредником.

> • Xid – идентификатор транзакции. Случайное число, которое используется клиентом и сервером для сопоставления запросов и ответов.

> • Secs – время в секундах, прошедшее с отправки первого запроса или начала обновления конфигурации.

> • Flags – Флаги. Некоторые клиенты не могут получать одноадресные IP-датаграммы до того, как будут установлены параметры стека TCP/IP. Для решения этой проблемы в протоколе DHCP используется поле флагов (flags).

> • Ciaddr – IP-адрес клиента. Заполняется только если клиент находится в состояниях BOUND, RENEW или REBINDING и может отвечать на ARP-запросы.

> • Yiaddr – ‘your’ (клиентский) IP-адрес.

> • Siaddr – адрес следующего сервера, используемого при загрузке, вставляется сервером в сообщения DHCPOFFER и DHCPACK.

> • Giaddr – адрес агента-посредника, в случае, если он есть используется.

> • Chaddr – адрес оборудования клиента.

> • Sname – имя хоста сервера (опционально).

> • File – имя загрузочного файла (опционально).


> Включите интерфейс `eth1` на рабочем месте, чтобы tshark мог прослушивать его.

```
ifconfig
sudo ifconfig eth1 up
```

> Подключитесь к командной строке рабочего места. Используя утилиту `dhclient` запустите DHCP-клиент на интерфейсе eth1 рабочего места:

```
sudo dhclient eth1
ifconfig
```

> С помощью утилиты ifconfig выведите информацию о сетевых интерфейсах на рабочем месте.

> 1. Введите номер первого DHCP-пакета:

__`Ответ:`__
`1`


> 2. Название(в числовом формате) транспортного протокола используемого для передачи сообщений DHCP:

__`Ответ:`__
`17`

> 3. Номер порта отправителя DHCP:

__`Ответ:`__
`68`
> 4. Номер порта получателя DHCP:

__`Ответ:`__
`67`

> 5. MAC-адрес отправителя сообщения DHCP:

__`Ответ:`__
`9e:22:ae:42:22:07`


> 6. MAC-адрес получателя сообщения DHCP:

__`Ответ:`__
`ff:ff:ff:ff:ff:ff`

> 7. IP-адрес отправителя сообщения DHCP:

__`Ответ:`__
`0.0.0.0`

> 8. IP-адрес получателя сообщения DHCP:

__`Ответ:`__
`255.255.255.255`


#### 4. Анализ перехваченных пакетов. Часть2

> DHCP сервер может предоставлять настройки, используя следующие методы:

> - Выделение вручную (по MAC адресу)

> - Динамическое выделение (пул адресов)

> - Автоматическое выделение

> Первый метод подразумевает использование DHCP для определения уникального аппаратного адреса каждой сетевой карты, подключенной к сети, и затем продолжительного предоставления неизменной конфигурации каждый раз, когда DHCP клиент делает запрос на DHCP сервер, используя это сетевое устройство. Это гарантирует, что определенный адрес будет автоматически присваиваться этой сетевой карте на основе ее MAC адреса.

> При втором методе, DHCP сервер будет выделять IP адрес из пула адресов (иногда называемым диапазоном или областью) на период времени (или в аренду), который настраивается на сервере, или до тех пор, пока клиент не проинформирует сервер, что больше вообще не нуждается в IP-адресе. Таким образом, клиенты получают свои настройки динамически по принципу «первый пришел - первый обслужен». Когда DHCP клиент отсутствует в сети определенное время, настройка считается просроченной и возвращается в пул адресов для использования другими DHCP клиентами. Это означает, что адрес арендуется или выдается на определенный период времени. По истечении этого периода клиент должен повторно договариваться об использовании адреса с сервером.

> Используя третий метод, DHCP автоматически присваивает постоянный IP адрес устройству, выбранный из пула доступных адресов. Обычно DHCP используется для выдачи временного адреса, но DHCP сервер может использовать бесконечное время аренды. Два последних метода можно рассматривать, как автоматические, поскольку DHCP сервер выдает адреса без дополнительного вмешательства. Единственная разница заключается в том, насколько арендуется адрес, другими словами, когда истечет время использования адреса клиентом. Ubuntu поставляется вместе с DHCP сервером и клиентом. Сервером является dhcpd (сервис протокола динамического выделения адресов). Клиент, поставляемый с Ubuntu, - это dhclient и он может быть установлен на все компьютеры, требующие автоматических настроек. Обе программы просты в установке и настройке и автоматически стартуют при загрузке системы.

> Введите номер опции, в которой передаётся тип DHCP сообщения: 

__`Ответ:`__
`53`

> Какое поле в сообщениях DHCPOFFER и DHCPACK используется в качестве идентификатора сервера:

__`Ответ:`__
`DHCP Server Identifier`


> Какая опция используется для определения длительности аренды IP-адреса:

__`Ответ:`__
`51`


#### 5. Установка lease-time

> Параметр lease-time в подменю /ip dhcp-server - время, на которое выделяется адрес. Клиент попытается повторно занять этот адрес по истечении половины этого времени или запросит новый адрес по завершении.

```
ip dhcp-server set lease-time=10s
numbers: 0
ip dhcp-server print
```

#### 6. Повторный запрос адреса

> Тип сообщения протокола DHCP указывается с помощью опции с кодом 53 и может иметь следующие значения:

> Основные

> 1 – DHCPDISCOVER – широковещательный запрос от клиента, используемый для обнаружения доступных DHCP-серверов.

> 2 – DHCPOFFER – ответ сервера на сообщение DHCPDISCOVER с предложением параметров для настройки.

> 3 – DHCPREQUEST – сообщение от клиента серверу для запроса параметров, предложенными сервером или для повторного запроса параметров при перезапуске клиента или возобновлении аренды.

> 4 – DHCPACK – подтверждение сервером параметров для клиента, включая сетевой адрес.

> 5 – DHCPNAK – ответ сервера на запрос клиента, сообщающий о том, что данный сетевой адрес не может быть установлен или время аренды адреса истекло.

> 6 – DHCPDECLINE – сообщение от клиента серверу, о том, что адрес уже используется.

> 7 – DHCPRELEASE – сообщение клиента о завершении аренды адреса.

> 8 – DHCPINFORM – запрос дополнительных сетевых параметров клиентом у сервера, при условии, что у клиента уже настроен сетевой адрес.


> Выпишите номер первого сообщения, которое используется для повторного запроса адреса по истечении таймера:

__`Ответ:`__
`1`

> Выпишите тип данного сообщения протокола DHCP(в числовом формате):

__`Ответ:`__
`3`


#### 7. DNS.Проверка настроек интерфейсов

> Domain Name System (DNS, англ. «система доменных имен», RFC 1034, RFC 1035) - это распределенная база данных, содержащая информацию об узлах сети (доменные имена узлов, их адреса и др.). Распределенная структура дает возможность локально управлять отдельными сегментами общей базы, а также позволяет сделать данные каждого сегмента доступным и всей сети посредством использования механизма «клиент-сервер». Надежность и адекватная производительность основаны на репликации и кэшировании.

> Перед началом работы необходимо убедиться, что на рабочем месте и его маршрутизаторе корректно настроена адресация и маршрутизация к узлу предоставления услуг. Для этого необходимо на рабочем месте выполнить команду:

```
ping -c 4 10.2.1.10
```

> Если от сервера не было получено ни одного ответа, то необходимо выполнить проверку наличия следующих настроек и дополнить их в соответствии с данной рекомендацией:

> на Рабочем месте:

```
ifconfig

sudo ifconfig eth1 192.168.109.20 netmask 255.255.255.0 up

ifconfig

sudo ip route add 10.2.1.0/24 via 192.168.109.1

ip route
```

> на маршрутизаторе:

```
/ip address 
print
add interface=ether2 address=192.168.109.1 netmask=255.255.255.0


/ip route
print
add dst-address=10.2.1.0/24 gateway=10.2.1.254
```


#### 8. Настройка DNS-сервера

> Серверная часть клиент-серверного механизма DNS представлена программами, которые называются DNS-серверами (name servers, дословно – серверами имен). DNS-серверы владеют информацией о некоторых сегментах базы данных и делают ее доступной клиентам, которые называются поисковыми анализаторами (resolvers). Как правило, DNS-клиент - это просто набор библиотечных функций, которые создают запросы и посылают их по сети серверу имен. Они отвечают за перевод запроса программы в запрос к DNS-серверу и за перевод ответа сервера в ответ для программы.

> Подключитесь к консоли сервера приложений, нажав на пиктограмму IPSrv. Запустите скрипт, для создания файлов, содержащих параметры работы DNS-сервера. Используя команду: `conf-dns.sh 6`

> Проанализируйте вывод данной команды. Введите названия редактируемых файлов в том же порядке, как они представлены в консольном выводе

__`Ответ:`__
`named.conf.options`

__`Ответ:`__
`named.conf.local`

__`Ответ:`__
`db.rm06.ip.lab`


__`Ответ:`__
`db.1.2.10`


#### 9. Запуск DNS-сервера

> Команда NETSTAT предназначена для получения сведений о состоянии сетевых соединений и слушаемых на данном компьютере портах TCP и UDP, а также, для отображения статистических данных по сетевым интерфейсам и протоколам.

> Запустите сервер посредством команды:

```
/etc/init.d/bind9 start
```

> Проверьте, что сервер был запущен на нужных адресах, используйте для этого команду:

```
netstat -lnp | grep :53
```


#### 10. Настройка резолвера DNS

> DNS-серверы хранят часть распределенной базы данных о соответствии символьных имен и IP-адресов узлов сети. Эта база данных распределена по административным доменам сети Интернет. Клиенты DNS-сервера знают IP-адрес сервера DNS своего административного домена и по протоколу IP передают запрос, в котором сообщают известное символьное имя узла и просят вернуть соответствующий ему IP-адрес. Если данные о запрошенном соответствии хранятся в базе данного DNS-сервера, то он сразу посылает ответ клиенту.


> Настройте `резолвер` DNS на своем рабочем месте. Для этого необходимо создать файл `resolv.conf` и записать в него строку "nameserver 10.2.1.6". Используйте для этого команду:

> на клиенте

```
echo "nameserver 10.2.1.6" | sudo tee /etc/resolv.conf
```
> Проверьте, что файл записан верно, используя команду:

```
cat /etc/resolv.conf 
```


#### 11. Анализ DNS-запроса

> Все сообщения протокола DNS имеют единый формат. Каждое сообщение разделяется на 5 секций, некоторые из которых могут быть пустыми Каждое сообщение содержит заголовок, в котором описывается набор следующих за ним секций, а также определяет, является ли сообщение запросом, ответом или выполняет какую-либо другую операцию.

> dig (сокращение от «domain information groper») — утилита (DNS-клиент), предоставляющая пользователю интерфейс командной строки для обращения к системе DNS. Позволяет задавать различные типы запросов и запрашивать произвольно указываемые сервера.

> Запустите CLI рабочего места. Проверьте работу системы доменных имен, запустив команду dig из консоли рабочего места: 

```
dig dns.rm06.ip.lab
```

> Номер первого пакета dns-запроса:

__`Ответ:`__
`1`

> Какой транспортный протокол используется для передачи сообщений DNS(ответ введите в числовом формате):

__`Ответ:`__
`17`

> IP-адрес DNS-сервера:

__`Ответ:`__
`10.2.1.6`

> Номер порта DNS-сервера:

__`Ответ:`__
`53`

> Флаги dns-запроса:

__`Ответ:`__
`0x0120`

> Имя запрашиваемой записи

__`Ответ:`__
`dns.rm06.ip.lab`

> Тип запрашиваемой записи(в числовом формате):

__`Ответ:`__
`1`


#### 12. Анализ DNS-ответа

> Названия секций, идущих после заголовка, выбраны исходя из функций, которые они выполняют в стандартном запросе.

> - Секция «Вопрос (Question)» содержит поля, описывающие запрашиваемые у сервера имен данные. Это поля «Тип запроса (QTYPE)», «Класс запроса (QCLASS)» и «Запрашиваемое имя домена (QNAME)».

> Три последние секции имеют одинаковый формат, представляющий из себя список ресурсных записей (при этом список запись может быть пустым).

> - Секция «Ответ (Answer)» содержит ресурсные записи, которые отвечают на вопрос.
> - Cекция «Источник (Authority)» - ресурсные записи, описывающие авторитативный сервер имен.
> - Cекция «Дополнение (Additional)» - ресурсные записи, которые относятся к запросу, но напрямую не отвечают на «вопрос».

> Номер первого пакета dns-ответа:

__`Ответ:`__
`2`

> Время жизни записи

__`Ответ:`__
`3600`

> Имя авторитетного сервера имен

__`Ответ:`__
`dns.rm06.ip.lab`

> Результирующий адрес для запрашиваемой информации

__`Ответ:`__
`10.2.1.6`


#### 13. Анализ пакетов реверсивного DNS-запроса

> Основная задача протокола DNS состоит в определении соответствия между сетевыми адресами узлов сети и их удобочитаемыми названиями. Существует два варианта определения этого соответствия - прямое и реверсивное определение. При прямом разрешении DNS-сервер по имени определяет и выдает сетевой адрес, а при реверсивном - по адресу ищет соответствующее имя.

> `PTR` (pointer) — отображает адрес в доменное имя устройства. Для этого был создан специальный домен (`IN-ADDR.ARPA.`), структура которого совпадает со структурой IP-адресов.

> Проверьте возможность обратного разрешения адреса, запустив программу dig на рабочем месте с флагом -x:

```
dig -x 10.2.1.6
```

> Номер пакета первого dns-запроса. Из данного пакета выпишите следующие два параметра:

__`Ответ:`__
`1`

> Имя запрашиваемой записи

__`Ответ:`__
`6.1.2.10.in-addr.arpa`

> Тип запрашиваемой записи(в HEX-формате)
> PTR Domain Name Pointer
__`Ответ:`__
`` 
> не 0xac99, 0x0001, 0x0120, C


> Выпишите номер пакета первого dns-ответа. Из данного пакета выпишите следующий параметр:

__`Ответ:`__
`2`

> Имя домена для запрашиваемой записи

__`Ответ:`__
`dns.rm06.ip.lab`
