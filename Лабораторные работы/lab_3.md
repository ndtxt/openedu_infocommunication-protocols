# Вспомогательные протоколы сетевого уровня

1. Настройка интерфейса для рабочего места
2. Просмотр настроек интерфейса на маршрутизаторе доступа
3. Изменение IP-адреса маршрутизатора
4. Вывод ARP таблицы
5. Захват пакетов
6. Анализ запроса ARP
7. Анализ ответа на запрос ARP
8. Изменение записи соответствия таблицы ARP 20
9. Удаление записи из таблицы ARP
10. ICMP. Захват пакетов с записью в файл
11. Настройка маршрута к сети
12. Подбор актуального TTL
13. Использование traceroute
14. Проверка связи
15. Изменение MTU

---

#### 1. Настройка интерфейса для рабочего места

> С помощью утилиты `ifconfig` выведите информацию о сетевых интерфейсах на рабочем месте.
> С помощью утилиты ifconfig с правами привилегированного пользователя установите IP-адрес 192.168.108.20 с маской /24 для интерфейса eth1, которым рабочее место будет соединено с маршрутизатором.

```
$ sudo ifconfig eth1 192.168.108.20 netmask 255.255.255.0
```

> Определите: имя интерфейса, соединенного с маршрутизатором:
__`Ответ:`__
`eth1`

> MAC-адрес интерфейса, соединенного с маршрутизатором:
__`Ответ:`__
`a6:9a:74:43:a4:10`


#### 2. Просмотр настроек интерфейса на маршрутизаторе доступа

> Команда print выводит на экран всю информацию, относящуюся к текущему уровню команд. Так, /system clock print выводит системные дату и время, /ip route print выводит все маршруты и т.д.Если на текущем уровне команд доступен список объектов, разрешённых для редактирования, то команда print при выводе обеспечит нумерацию элементов этого списка в порядке очерёдности, учитывая изменения, которым были подвергнуты эти элементы, ранее.

> Используя команду print в подменю `/interface ethernet` маршрутизатора Mikrotik(MiTk), определите информацию для интерфейса ether2, с которым будет соединено рабочее место.

> Выпишите MAC-адрес для интерфейса ether2.
__`Ответ:`__
`AE:87:14:75:54:A3`


#### 3. Изменение IP-адреса маршрутизатора

> Команда add создает новый объект с заданными параметрами. Обычно новый объект добавляется в конец списка. Некоторые свойства объекта требуется задавать всегда, например, интерфейс для нового адреса, а некоторые могут быть заданы автоматически с использованием значений по умолчанию.

> Используя команду add в подменю `/ip address` маршрутизатора добавьте IP-адрес: 192.168.108.1 с маской /24, для интерфейса ether2, к которому подключено рабочее место.

```
add interface=ether2 address=192.168.108.1 netmask=255.255.255.0 
```

> Выпишите имя интерфейса, к которому подключено рабочее место: 
__`Ответ:`__
`ether2`

> Выпишите IP-адрес интерфейса, к которому подключено рабочее место:

```
/ip address print
```

__`Ответ:`__
`192.168.108.1`


#### 4. Вывод ARP таблицы

> ARP (англ. Address Resolution Protocol — протокол определения адреса) - протокол, используемый для согласования IP-адреса, присвоенного некоему интерфейсу оборудования, и его физического адреса, используемого на канальном уровне в сетях, построенных с помощью технологий стандартов IEEE 802.

> Выведите таблицу arp на рабочем месте, используя команду `arp`
> Проверьте, что в таблице нет строки соответствия для IP и MAC адресов маршрутизатора.
> Если строка соответствия есть, то удалите её, для этого используйте команду arp в привилегированном режиме, с параметром -d и указанием IP-адреса. `sudo arp -d IP-адрес`. Параметр -d удаляет узел, соответствующий заданному IP-адресу.

> Проверить, что в таблице нет строки соответствия IP и MAC адресов маршрутизатора.


##### 5. Захват пакетов

> В семействе протоколов `IPv6` ARP не существует, его функции возложены на `ICMPv6`.

> Для того, чтобы отфильтровать интересующие нас пакеты, в строке фильтра в WebShark следует ввести значение для фильтрации пакетов по протоколам ARP и ICMP, указав для этого значение: arp or icmp.

```
ping -c 4 192.168.108.1
```

> Выпишите значение поля Type (в числовом формате) заголовка кадра Ethernet, соответствующее протоколу ARP.
__`Ответ:`__
`0x0806`


#### 6. Анализ запроса ARP

> ARP-таблицы имеют динамический характер, каждая запись в ней хранится определенное время, после чего удаляется. Администратор сети может добавить статическую запись в ARP-таблицу, эта запись не будет подвержена автоматическому удалению по прошествии какого-либо времени.

> Проанализируйте запрос протокола ARP сопоставления IP и MAC-адресов.

> Выпишите в отчет следующие значения из пакета, содержащего ARP запрос:

> MAС-адрес получателя (arp-запроса):￼ 

__`Ответ:`__
`a6:9a:74:43:a4:10`

> Тип ARP сообщения(opcode)(в числовом формате):

__`Ответ:`__ 
`1`

> IP-адрес, для которого запрашивается соответствующий MAC-адрес.

__`Ответ:`__
`192.168.108.20`

> MAC-адрес используемый в качестве искомого мас-адреса (target mac-address)

__`Ответ:`__
`00:00:00:00:00:00`


#### 7. Анализ ответа на запрос ARP

> Для определения MAC-адреса получателя по известному IP-адресу, хост формирует широковещательный Ethernet-кадр, содержащий ARP-запрос (ARP-Request). Запрос содержит MAC и IP отправителя и IP получателя, а в качестве MAC-адреса получателя используется широковещательный MAC-адрес. Хост, обнаруживший свой IP-адрес в поле "сетевой адрес получателя", дописывает свой MAC-адрес и отправляет ARP-ответ (ARP-Reply) тому, кто совершил запрос. Получив искомый MAC-адрес, хост заносит его в свою ARP-таблицу.

> Проанализируйте ответ на запрос протокола ARP сопоставления IP и MAC-адресов.

> Выпишите в отчет следующие значения из ARP пакета(для корректной проверки все поля должны быть заполнены):

> MAС-адрес отправителя:

__`Ответ:`__
`a6:9a:74:43:a4:10`

> Тип ARP-сообщения (opcode)(в числовом формате):

__`Ответ:`__
`2`

> Результирующий MAC-адрес (target mac-address)

__`Ответ:`__
`ae:87:14:75:54:a3`


#### 8. Изменение записи соответствия таблицы ARP 20

> 

__`Ответ:`__
``

> Утилита командной строки arp используется для отображения и изменения таблиц преобразования IP-адресов в физические (MAC - адреса), используемые протоколом разрешения адресов (Address Resolution Protocol - ARP ).

>  Запустите утилиту `ping` для постоянного мониторинга соединения между рабочим местом и маршрутизатором. Откройте второе окно командной строки рабочего места.

> В новом окне введите команду для просмотра существующих записей в таблице ARP: `arp -n`

> Используя параметр –s команды arp, измените запись соответствия MAC-адреса и IP-адреса маршрутизатора.
`sudo arp -s IP-адрес новый_MAC-адрес`

> Вернитесь в терминал, в котором запущен ping. Остановите выполнение команды ping используя пиктограмму Abort.Сделайте выводы о том, как изменился результат выполнения команды ping.

> Что является причиной этих изменений(выберите один ответ):

> ICMP-запрос отправляется с правильным IP-адресом получателя и неправильным MAC-адресом назначения. Удаленный хост не получает запрос.
> ICMP-запрос отправляется с правильным IP-адресом получателя и неправильным MAC-адресом назначения. Удаленный хост получает запрос, но не может отправить ICMP-ответ
> Удалённый хост отправляет ответ, но СlienSoho не принимает его, так как у него записано другое соответствие MAC и IP

__`Ответ:`__
`ICMP-запрос отправляется с правильным IP-адресом получателя и неправильным MAC-адресом назначения. Удаленный хост не получает запрос.`


#### 9. Удаление записи из таблицы ARP

> Для просмотра всех доступных параметров команды arp введите `arp --help`

> Откройте консоль рабочего места, введите команду для просмотра существующих записей в таблице ARP: 
```
arp
```

> Используя параметр –d команды arp, удалите запись соответствия MAC-адреса и IP-адреса маршрутизатора
`sudo arp -d IP-адрес`

```
sudo arp -d 192.168.108.1
```
> Выведите arp таблицу ещё раз и проанализируйте изменения.

> В консоли рабочего места запустите утилиту ping, для проверки связи с маршрутизатором MikroTik

> Выведите arp таблицу ещё раз и проанализируйте изменения.

> Что является причиной этих изменений(выберите один ответ):

> Mikrotik опрашивает подключённые устройства на наличие своих IP и mac адресов в клиентских arp-таблицах, в случае их отсутствия Mikrotik сам добавляет это соответствие на клиентское устройство.
> ClSoho отправляет широковещательный arp-запрос, Mikrotik отправляет ответ, содержащий соответствие IP и mac адресов.
> ClSoho восстанавливает соответствие IP и mac адресов Mikrotik из информации о предыдущих состояниях arp-таблицы.
> Так как нет соответствия MAC и IP адресов, ClSoho начинает отправлять ICMP-запросы широковещательно, и они доходят до маршрутизатора
> ClSoho отправляет широковещательный arp-запрос, все устройства в сети проверяют наличие этого IP-адреса в своих таблицах и в случае его обнаружения, отправляют данные об этом хосте

__`Ответ:`__
`ClSoho отправляет широковещательный arp-запрос, Mikrotik отправляет ответ, содержащий соответствие IP и mac адресов.`


#### 10. ICMP. Захват пакетов с записью в файл

> Протокол ICMP для проверки достижимости узлов сети использует два типа сообщений:эхо-запрос и эхо-ответ. Идентифицировать конкретный тип сообщения протокола ICMP можно по значению поля Тип.

> Используя утилиту ping, отправьте запрос проверки связи (ключ -с – количество генерируемых запросов):

```
ping -c 192.168.108.1
```

> Для того, чтобы отфильтровать интересующие нас пакеты, в строке фильтра в WebShark следует ввести значение для фильтрации пакетов по протоколу ICMP, указав для этого значение: icmp.

> Значение поля Протокол заголовка IP для протокола ICMP(в числовом формате)(из протокола IPv4): 

__`Ответ:`__
`1`

> Тип(в числовом формате) сообщения эхо-запрос протокола ICMP: 

__`Ответ:`__
`8`

> Тип(в числовом формате) сообщения эхо-ответ протокола ICMP:

__`Ответ:`__
`0`


#### 11. Настройка маршрута к сети

> `iproute2` — это набор утилит для управления параметрами сетевых устройств в ядре Linux. Эти утилиты были разработаны в качестве унифицированного интерфейса к ядру Linux, которое непосредственно управляет сетевым трафиком. iproute2 заменил полный набор классических сетевых утилит UNIX, которые ранее использовались для настройки сетевых интерфейсов, таблиц маршрутизации и управления arp‐таблицами: `ifconfig, route, arp, netstat и других, предназначенных для создания IP‐туннелей`.

> С помощью утилит из пакета iproute2 настройте на рабочем месте маршрут к сети 10.2.0.0/16 через маршрутизатор рабочего места:

```
sudo ip route add 10.2.0.0/16 via 192.168.108.1
```

> где X.X.X.X–IP-адрес маршрутизатора, настроенный на интерфейсе, соединённом с рабочим местом (ClSoho).

> Проверьте успешность создания маршрута с помощью команды:

```
ip route show
```

> Используя утилиту ping, отправьте запрос проверки связи c адресом 10.2.0.254, указав при этом TTL=1, используя параметр -t:

```
ping -c 1 -t 1 10.2.0.254
```

> Проанализируйте перехваченные пакеты. Выпишите следующие значения из принятого ICMP-пакета:

> IP-адрес отправителя ответа: 

__`Ответ:`__
`192.168.108.1`

> Тип(в числовом формате) ответа ICMP:

__`Ответ:`__
`11` 
> time to live exceeded 


> код(в числовом формате) протокола ICMP

__`Ответ:`__
`0`
> time to live exceeded in transit


#### 12. Подбор актуального TTL

> Time to live (TTL) — предельный период времени или число итераций или переходов, до достижения которого набор данных (пакет) может существовать. Определяет максимальное количество хопов (hop, то есть прыжок, участок между маршрутизаторами), которое пакет может пройти. При достижении величины, заданной в поле TTL — пакет отбрасывается. Наличие этого параметра не позволяет пакету бесконечно ходить по сети.

> Постепенно увеличивая значение TTL с шагом 1, добейтесь успешного ответа на эхо-запрос.

```
ping -c 1 -t 1 10.2.0.254
```
> Проанализируйте перехваченные пакеты. Выпишите следующие значения:

> Количество хопов до целевого хоста:
__`Ответ:`__
`2`

> IP-адреса узлов, через которые прошел пакет(адреса введите через пробел): 
`192.168.108.1 10.2.0.254`


#### 13. Использование traceroute

> Команда traceroute последовательно опрашивает и измеряет время задержки до всех маршрутизаторов на пути прохождения пакета, пока не будет достигнут целевой хост. Если между какими-либо двумя маршрутизаторами наблюдается большой рост задержки, значит, этот участок маршрута имеет особенности, влияющие на увеличение времени прохождения пакета до хоста назначения.

> Используя утилиту traceroute, проверьте результат, полученный в предыдущем пункте

```
traceroute 10.2.0.254
```
> Сравните работу утилиты traceroute с методом, использованным ранее.

> Количество хопов до целевого хоста:

__`Ответ:`__
`192.168.108.1 10.2.0.254`


#### 14. Проверка связи

> Устройство пакета ICMP следующее: 
> -Заголовок (4 байта) - первый байт определяет тип пакета, второй - код операции, третий и четвёртый представляют собой контрольную сумму.
> -Поле данных, размер которого зависит от типа пакета и его функции. В некоторых случаях может быть установленным с уровня инструмента, например, команда ping в Windows устанавливает размер данных пакета ECHO_REQUEST на 32 байта, а версия, встречающаяся в системах Unix на 56 байтов.

> Используя утилиту ping, отправьте запрос проверки связи рабочего места с адресом 10.2.0.253.

```
ping -c 4 10.2.0.253
```

> Адрес отправителя ICMP-ответа:

__`Ответ:`__
`192.168.108.20`

> Тип ответа ICMP:

__`Ответ:`__
`3`

> Код протокола ICMP:

__`Ответ:`__
`1`
> Destination unreachable (Host unreachable)


#### 15. Изменение MTU

> Команда set позволяет изменять значения общих параметров или параметров объектов. Аргументами команды set являются значения, которые могут быть изменены. Для того чтобы вывести список доступных аргументов введите символ «?» или дважды нажмите «Tab» `do  value  name`. Команда set может выполняться для нескольких элементов списка объектов одновременно. На экран данная команда ничего не выводит. Термин maximum transmission unit (MTU) означает максимальный размер полезного блока данных одного пакета, который может быть передан протоколом без фрагментации.
> Используя команду set , установите значение mtu=500 байт для исходящего интерфейса ether3 маршрутизатора.

```
/interface ethernet
print
set mtu=500 ether3
print
```

> Используя утилиту ping отправьте запрос проверки связи с адресом 10.2.0.254, указав размер пакета 1300 байт, используя параметр –s и установив флаг Don’t Fragment :

```
ping -c 1 -s 1300 -M do 10.2.0.254
```

> Адрес отправителя ответа:

__`Ответ:`__
`192.168.108.1`

> Тип ответа ICMP

__`Ответ:`__
`3`

> Код протокола ICMP:

__`Ответ:`__
`4`

> Destination unreachable (Fragmentation needed)
